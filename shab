#!/usr/bin/env bash
#
# Evaluates a file with bash variable substitution.
#
# Usage: shab [template-file|-]
set -euo pipefail

if type cat &>/dev/null; then
    dog() { cat "$@"; }
else
    dog() { # eponymously slow cat-polyfill hostile to nulls
        [ ${#@} -ne 0 ] || set -- -
        for fn; do
            [ "$fn" != - ] || fn=/dev/stdin
            while IFS= read -r line; do
                printf "%s\n" "$line"
            done <"$fn"
            printf "%s" "$line"
        done
    }
fi
export -f dog
shab() {(
  local id=${RANDOM}_${RANDOM}
  eval "$(echo "set -eu; dog <<SHAB_$id"; dog "${1:--}"; echo; echo "SHAB_$id")"
)}

# Works both as a sourced file or executable
if [[ ${BASH_SOURCE[0]} == "$0" ]]; then
  shab "$@"
fi
